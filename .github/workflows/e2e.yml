name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_r2:
        description: 'Run R2 storage tests'
        required: false
        default: true
        type: boolean
      large_file_size_gb:
        description: 'Large file test size in GB'
        required: false
        default: '1'
        type: string

jobs:
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest

    steps:
      - name: Check required secrets
        id: check-secrets
        env:
          R2INDEX_API_URL: ${{ secrets.R2INDEX_API_URL }}
        run: |
          if [ -z "$R2INDEX_API_URL" ]; then
            echo "::warning::R2INDEX_API_URL secret not configured, skipping E2E tests"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v6
        if: steps.check-secrets.outputs.skip != 'true'

      - uses: actions/setup-python@v6
        if: steps.check-secrets.outputs.skip != 'true'
        with:
          python-version: '3.12'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: python
        run: pip install -e .

      - name: Run E2E tests
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          E2E_LARGE_FILE_SIZE_GB: ${{ inputs.large_file_size_gb || '1' }}
          R2INDEX_API_TOKEN: ${{ secrets.R2INDEX_API_TOKEN }}
          R2INDEX_API_URL: ${{ secrets.R2INDEX_API_URL }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          if [ "${{ inputs.test_r2 }}" != "false" ] && [ -n "$R2_ACCESS_KEY_ID" ]; then
            python e2e_test.py "$R2INDEX_API_URL" "$R2INDEX_API_TOKEN" "$R2_ACCESS_KEY_ID" "$R2_SECRET_ACCESS_KEY" "$R2_ACCOUNT_ID"
          else
            python e2e_test.py "$R2INDEX_API_URL" "$R2INDEX_API_TOKEN"
          fi
